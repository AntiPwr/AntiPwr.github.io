<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poetry | Sea Level</title>
    <link rel="stylesheet" href="https://use.typekit.net/hpo3tdq.css">
    <link rel="stylesheet" href="CSS/poetry_style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="page-container">
        <header>
            <nav class="top-nav">
                <div class="nav-left">
                    <a href="../index.html">Home</a>
                </div>
                <div class="nav-title">
                    <h1>Poetry Collection</h1>
                </div>
                <div class="nav-right">
                    <!-- Added empty div to balance the layout -->
                    &nbsp;
                </div>
            </nav>
        </header>

        <section class="featured-poem-section">
            <h2>Featured Poem</h2>
            <div class="poem-display">
                <div class="poem-container">
                    <!-- Poems will be loaded here by JavaScript -->
                </div>
                <div class="poem-controls">
                    <button id="prev-poem" class="control-btn"><</button>
                    <button id="next-poem" class="control-btn">></button>
                </div>
            </div>
        </section>

        <section class="poem-archive">
            <h2>Archive</h2>
            <div class="alphabet-index">
                <!-- Alphabet index will be generated by JavaScript -->
            </div>
            <div class="sort-controls">
                <h3>Sort Poems By</h3>
                <select id="sort-dropdown" class="sort-dropdown">
                    <option value="date-desc">Newest to Oldest</option>
                    <option value="date-asc">Oldest to Newest</option>
                    <option value="alpha-asc">A-Z</option>
                    <option value="alpha-desc">Z-A</option>
                </select>
                <div class="sort-buttons">
                    <!-- Keep old buttons in DOM but hidden by CSS -->
                    <button class="sort-btn active" data-sort="date-desc">Newest to Oldest</button>
                    <button class="sort-btn" data-sort="date-asc">Oldest to Newest</button>
                    <button class="sort-btn" data-sort="alpha-asc">A-Z</button>
                    <button class="sort-btn" data-sort="alpha-desc">Z-A</button>
                </div>
            </div>
            <div class="archive-container">
                <!-- Archive contents will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Lightbox for enlarged poem view -->
    <div id="poem-lightbox" class="lightbox">
        <div class="lightbox-content">
            <span class="close-lightbox">&times;</span>
            <img id="lightbox-image" src="" alt="Enlarged poem">
            <div id="lightbox-text" class="lightbox-text"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Array of poem objects with metadata
            const poems = [
                {
                    file: 'Extrema.jpg',
                    date: '2024-09',
                    title: 'Extrema',
                    type: 'image'
                },
                {
                    file: 'DoubleSpeak.jpg',
                    date: '2024-11',
                    title: 'Double Speak',
                    type: 'image'
                },
                {
                    file: 'Simile of Souls.md',
                    date: '2024-06',
                    title: 'Simile of Souls',
                    type: 'text'
                },
                {
                    file: 'Dissonance II.md',
                    date: '2025-01',
                    title: 'Dissonance II',
                    type: 'text'  
                }
                // Add all your poems here with dates and types
            ];
            
            // Current poem index
            let currentPoemIndex = 0;
            let currentSortMethod = 'date-desc'; // Default sort: newest to oldest
            
            // Auto-rotation interval (in milliseconds)
            const rotationInterval = 30000; // 30 seconds
            let autoPlayInterval;
            let isAutoPlaying = true;
            
            // Lightbox elements
            const lightbox = document.getElementById('poem-lightbox');
            const lightboxImg = document.getElementById('lightbox-image');
            const lightboxText = document.getElementById('lightbox-text');
            const closeLightbox = document.querySelector('.close-lightbox');
            
            // Function to load markdown content
            async function loadMarkdownPoem(file) {
                try {
                    // Log the attempt to fetch the file for debugging
                    console.log(`Attempting to load: poems/${file}`);
                    
                    const response = await fetch(`poems/${file}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load poem: ${response.status} ${response.statusText}`);
                    }
                    return await response.text();
                } catch (error) {
                    console.error('Error loading markdown poem:', error);
                    // Return a formatted error message that will be shown to the user
                    return `**Error loading poem**\n\nThe poem file could not be loaded. Please check that "${file}" exists in the poems directory.\n\nTechnical details: ${error.message}`;
                }
            }
            
            // Simple markdown parser (handles basic formatting)
            function parseMarkdown(markdown) {
                // Handle line breaks
                let html = markdown.replace(/\n/g, '<br>');
                
                // Handle bold text
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Handle italic text
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                // Handle headers (h3)
                html = html.replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>');
                
                // Handle headers (h2)
                html = html.replace(/## (.*?)(\n|$)/g, '<h2>$1</h2>');
                
                // Handle headers (h1)
                html = html.replace(/# (.*?)(\n|$)/g, '<h1>$1</h1>');
                
                return html;
            }
            
            // Sort poems initially
            sortPoems(currentSortMethod);
            
            // Function to sort poems based on method
            function sortPoems(method) {
                currentSortMethod = method;
                
                // Update active button
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.sort === method);
                });
                
                // Also update dropdown selection
                document.getElementById('sort-dropdown').value = method;
                
                // Store the current poem before sorting
                const currentPoem = poems[currentPoemIndex];
                
                switch(method) {
                    case 'alpha-asc':
                        poems.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'alpha-desc':
                        poems.sort((a, b) => b.title.localeCompare(a.title));
                        break;
                    case 'date-asc':
                        poems.sort((a, b) => a.date.localeCompare(b.date));
                        break;
                    case 'date-desc':
                    default:
                        poems.sort((a, b) => b.date.localeCompare(a.date));
                        break;
                }
                
                // Regenerate the archive with sorted poems
                generateArchive();
                
                // REMOVED: The section that updates currentPoemIndex
                // Keep displaying the same poem in the featured section
            }
            
            // Format date string for display
            function formatDate(dateStr) {
                if (!dateStr) return 'Unknown date';
                
                const [year, month] = dateStr.split('-');
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                return `${months[parseInt(month) - 1]} ${year}`;
            }
            
            // Function to load and display poem
            async function displayCurrentPoem() {
                const poemContainer = document.querySelector('.poem-container');
                const poem = poems[currentPoemIndex];
                
                poemContainer.innerHTML = ''; // Clear container
                
                if (poem.type === 'image') {
                    // Display image poem
                    poemContainer.innerHTML = `
                        <img src="poems/${poem.file}" alt="${poem.title}" class="poem-image">
                        <span class="poem-date">${formatDate(poem.date)}</span>
                    `;
                    
                    // Add click event to open lightbox
                    const poemImage = poemContainer.querySelector('.poem-image');
                    poemImage.addEventListener('click', function() {
                        openLightbox(poem);
                    });
                } else {
                    // Display text poem preview
                    const poemPreview = document.createElement('div');
                    poemPreview.className = 'poem-text-preview';
                    poemPreview.innerHTML = `
                        <h3>${poem.title}</h3>
                        <p class="poem-preview-message">Click to read...</p>
                        <span class="poem-date">${formatDate(poem.date)}</span>
                    `;
                    
                    // Add click event to open text lightbox
                    poemPreview.addEventListener('click', function() {
                        openLightbox(poem);
                    });
                    
                    poemContainer.appendChild(poemPreview);
                }
            }
            
            // Function to open lightbox
            async function openLightbox(poem) {
                // Pause autoplay
                if (isAutoPlaying) {
                    clearInterval(autoPlayInterval);
                }
                
                // Reset content visibility
                lightboxImg.style.display = 'none';
                lightboxText.style.display = 'none';
                
                if (poem.type === 'image') {
                    // Set image source
                    lightboxImg.src = `poems/${poem.file}`;
                    lightboxImg.style.display = 'block';
                } else {
                    // Load and display markdown content
                    lightboxText.innerHTML = '<p>Loading poem...</p>';
                    lightboxText.style.display = 'block';
                    
                    try {
                        // Add a short delay to ensure loading message is visible
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Fetch and parse markdown
                        const markdown = await loadMarkdownPoem(poem.file);
                        const html = parseMarkdown(markdown);
                        
                        // Display formatted poem with title and date
                        lightboxText.innerHTML = `
                            <h2>${poem.title}</h2>
                            <div class="poem-content">${html}</div>
                            <div class="poem-metadata">
                                <span class="poem-date">${formatDate(poem.date)}</span>
                            </div>
                        `;
                    } catch (error) {
                        lightboxText.innerHTML = `
                            <h2>${poem.title}</h2>
                            <p>Error loading poem content.</p>
                            <p class="error-details">Please make sure the file "poems/${poem.file}" exists.</p>
                            <p class="error-details">Error: ${error.message}</p>
                        `;
                        console.error('Error in lightbox text display:', error);
                    }
                }
                
                // Show lightbox
                lightbox.style.display = 'flex';
                
                // Prevent scrolling of background
                document.body.style.overflow = 'hidden';
            }
            
            // Function to close lightbox
            function closeLightboxFunc() {
                lightbox.style.display = 'none';
                document.body.style.overflow = '';
                
                // Resume autoplay
                if (isAutoPlaying) {
                    autoPlayInterval = setInterval(nextPoem, rotationInterval);
                }
            }
            
            // Function to go to next poem
            function nextPoem() {
                currentPoemIndex = (currentPoemIndex + 1) % poems.length;
                displayCurrentPoem();
            }
            
            // Function to go to previous poem
            function prevPoem() {
                currentPoemIndex = (currentPoemIndex - 1 + poems.length) % poems.length;
                displayCurrentPoem();
            }
            
            // Initialize featured poem display
            displayCurrentPoem();
            
            // Start auto-rotation
            autoPlayInterval = setInterval(nextPoem, rotationInterval);
            
            // Set up control buttons
            document.getElementById('next-poem').addEventListener('click', function() {
                nextPoem();
                // Reset auto-rotation when manually changing
                if (isAutoPlaying) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = setInterval(nextPoem, rotationInterval);
                }
            });
            
            document.getElementById('prev-poem').addEventListener('click', function() {
                prevPoem();
                // Reset auto-rotation when manually changing
                if (isAutoPlaying) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = setInterval(nextPoem, rotationInterval);
                }
            });
            
            // Set up dropdown for sorting
            document.getElementById('sort-dropdown').addEventListener('change', function() {
                sortPoems(this.value);
            });
            
            // Lightbox event listeners
            closeLightbox.addEventListener('click', closeLightboxFunc);
            
            // Close lightbox when clicking outside the image
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightboxFunc();
                }
            });
            
            // Close lightbox with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && lightbox.style.display === 'flex') {
                    closeLightboxFunc();
                }
            });
            
            // Create alphabet index and archive
            function generateArchive() {
                const archiveContainer = document.querySelector('.archive-container');
                const alphabetIndex = document.querySelector('.alphabet-index');
                
                // Clear existing content
                archiveContainer.innerHTML = '';
                alphabetIndex.innerHTML = '';
                
                // Create letter groups if we're sorting alphabetically
                if (currentSortMethod.startsWith('alpha')) {
                    // Show the alphabet index for alphabetical sorting
                    alphabetIndex.style.display = 'flex';
                    
                    let letterSections = {};
                    
                    // Group poems by first letter
                    poems.forEach(poem => {
                        const firstLetter = poem.title[0].toUpperCase();
                        
                        if (!letterSections[firstLetter]) {
                            letterSections[firstLetter] = [];
                        }
                        
                        letterSections[firstLetter].push(poem);
                    });
                    
                    // Generate alphabet index
                    const alphabet = Object.keys(letterSections).sort();
                    alphabet.forEach(letter => {
                        const letterLink = document.createElement('a');
                        letterLink.href = `#section-${letter}`;
                        letterLink.textContent = letter;
                        alphabetIndex.appendChild(letterLink);
                    });
                    
                    // Generate archive sections by letter
                    alphabet.forEach(letter => {
                        const section = document.createElement('div');
                        section.id = `section-${letter}`;
                        section.className = 'letter-section';
                        
                        const heading = document.createElement('h3');
                        heading.textContent = letter;
                        section.appendChild(heading);
                        
                        const poemList = document.createElement('div');
                        poemList.className = 'poem-list';
                        
                        letterSections[letter].forEach(poem => {
                            const poemItem = createPoemItem(poem);
                            poemList.appendChild(poemItem);
                        });
                        
                        section.appendChild(poemList);
                        archiveContainer.appendChild(section);
                    });
                } else {
                    // Hide the alphabet index for date sorting
                    alphabetIndex.style.display = 'none';
                    
                    // For date sorting, group by year
                    let yearSections = {};
                    
                    // Group poems by year
                    poems.forEach(poem => {
                        const year = poem.date ? poem.date.split('-')[0] : 'Unknown';
                        
                        if (!yearSections[year]) {
                            yearSections[year] = [];
                        }
                        
                        yearSections[year].push(poem);
                    });
                    
                    // Get years and sort them
                    let years = Object.keys(yearSections);
                    if (currentSortMethod === 'date-desc') {
                        years.sort((a, b) => b - a); // Descending order
                    } else {
                        years.sort((a, b) => a - b); // Ascending order
                    }
                    
                    // Generate year sections without year links in index
                    years.forEach(year => {
                        const section = document.createElement('div');
                        section.id = `year-${year}`;
                        section.className = 'letter-section';
                        
                        const heading = document.createElement('h3');
                        heading.textContent = year;
                        section.appendChild(heading);
                        
                        const poemList = document.createElement('div');
                        poemList.className = 'poem-list';
                        
                        yearSections[year].forEach(poem => {
                            const poemItem = createPoemItem(poem);
                            poemList.appendChild(poemItem);
                        });
                        
                        section.appendChild(poemList);
                        archiveContainer.appendChild(section);
                    });
                }
            }
            
            // Helper function to create poem item
            function createPoemItem(poem) {
                const poemItem = document.createElement('div');
                poemItem.className = 'poem-item';
                
                const poemLink = document.createElement('a');
                poemLink.href = `#`;
                poemLink.dataset.poem = poem.file;
                poemLink.textContent = poem.title;
                
                // Add icon or indicator for text poems
                if (poem.type === 'text') {
                    poemLink.classList.add('text-poem');
                    const textIcon = document.createElement('span');
                    textIcon.className = 'text-poem-icon';
                    textIcon.innerHTML = '📝'; // Text indicator
                    poemLink.prepend(textIcon);
                }
                
                poemLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Find index of the selected poem
                    const selectedIndex = poems.findIndex(p => p.file === this.dataset.poem);
                    if (selectedIndex !== -1) {
                        // Open the lightbox directly when clicking a poem in the archive
                        const selectedPoem = poems[selectedIndex];
                        openLightbox(selectedPoem);
                        
                        // Also update the featured poem
                        currentPoemIndex = selectedIndex;
                        displayCurrentPoem();
                    }
                });
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'poem-date';
                dateSpan.textContent = formatDate(poem.date);
                
                poemItem.appendChild(poemLink);
                poemItem.appendChild(dateSpan);
                
                return poemItem;
            }
            
            // Generate the archive with default sorting
            generateArchive();
        });
    </script>
</body>
</html>


